<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hourglass">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Hourglass — Watch time pass, choose how to live.">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>⏱️</text></svg>">
    <title>Hourglass — Watch time pass, choose how to live</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .app-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .app-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .app-header .slogan {
            font-style: italic;
        }

        .management-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            color: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .management-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            transform: scale(1.05);
        }

        /* Management Modal */
        .management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .management-modal.active {
            display: flex;
        }

        .management-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .management-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .management-header h2 {
            font-size: 1.4rem;
            margin: 0;
        }

        .management-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .management-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .management-section {
            margin-bottom: 25px;
        }

        .management-section h3 {
            font-size: 1.1rem;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .management-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .management-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .management-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .management-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .management-item-icon {
            font-size: 1.3rem;
        }

        .management-item-name {
            font-weight: 500;
            color: #1f2937;
        }

        .management-item-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 10px;
            margin-left: 8px;
        }

        .management-item-actions {
            display: flex;
            gap: 6px;
        }

        .management-item-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .mgmt-edit-btn {
            background: #e0f2fe;
            color: #0369a1;
        }

        .mgmt-edit-btn:hover {
            background: #bae6fd;
        }

        .mgmt-delete-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .mgmt-delete-btn:hover {
            background: #fecaca;
        }

        .mgmt-add-btn {
            width: 100%;
            padding: 12px;
            background: #f0fdf4;
            border: 2px dashed #86efac;
            border-radius: 8px;
            color: #16a34a;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mgmt-add-btn:hover {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .subcategory-expand {
            padding: 6px 10px;
            background: #f3f4f6;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #6b7280;
            transition: all 0.2s;
        }

        .subcategory-expand:hover {
            background: #e5e7eb;
        }

        .subcategory-list {
            margin-top: 8px;
            margin-left: 30px;
            padding: 10px;
            background: #fafafa;
            border-radius: 8px;
            display: none;
        }

        .subcategory-list.expanded {
            display: block;
        }

        .subcategory-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .subcategory-item:last-child {
            margin-bottom: 0;
        }

        .subcategory-item-name {
            color: #4b5563;
        }

        .subcategory-item-badge {
            font-size: 0.65rem;
            padding: 2px 5px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 8px;
            margin-left: 6px;
        }

        .reset-section {
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            background: #fee2e2;
        }

        .view-toggle {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: #f9fafb;
        }

        .view-toggle button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
        }

        .view-toggle button.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }

        .view-toggle button:hover {
            background: #f3f4f6;
        }

        .tracker-container, .logs-container {
            padding: 30px;
        }

        .overview-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }

        .time {
            font-size: 4rem;
            font-weight: 700;
            color: #1f2937;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover {
            background: #059669;
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover {
            background: #dc2626;
        }

        .btn-reset {
            background: #6b7280;
            color: white;
        }

        .btn-reset:hover {
            background: #4b5563;
        }

        .category-selector {
            margin-bottom: 30px;
        }

        .category-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-selector h3 {
            color: #1f2937;
            font-size: 1.2rem;
            margin: 0;
        }

        .manage-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .manage-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .category-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 3px solid transparent;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .category-card.active {
            transform: scale(1.05);
        }

        .category-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .category-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1f2937;
        }

        .subcategory-panel {
            margin-top: 10px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .subcategory-panel label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .subcategory-panel select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #7dd3fc;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .subcategory-panel select:focus {
            outline: none;
            border-color: #0284c7;
        }

        .subcategory-panel select:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .custom-subs-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #bae6fd;
        }

        .custom-subs-list-title {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .custom-sub-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: white;
            border: 1px solid #e0f2fe;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .custom-sub-item span {
            color: #0369a1;
        }

        .custom-sub-actions {
            display: flex;
            gap: 4px;
        }

        .custom-sub-actions button {
            padding: 2px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }

        .edit-sub-btn {
            background: #e0f2fe;
            color: #0369a1;
        }

        .edit-sub-btn:hover {
            background: #bae6fd;
        }

        .delete-sub-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .delete-sub-btn:hover {
            background: #fecaca;
        }

        .active-timer-info {
            padding: 15px;
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            color: #1e40af;
            font-size: 0.95rem;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .category-stats {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .category-stats h3 {
            margin-bottom: 20px;
            color: #1f2937;
        }

        .category-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .category-bar-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .category-bar-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #111827;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .close-modal:hover {
            background: #f3f4f6;
        }

        .edit-log-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafbfc;
        }

        .edit-log-item:hover {
            border-color: #d1d5db;
        }

        .edit-log-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }

        .edit-log-row label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4b5563;
            min-width: 60px;
        }

        .edit-log-row input, .edit-log-row select {
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .edit-log-row input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        .edit-log-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-save-log {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save-log:hover {
            background: #059669;
        }

        .btn-delete-log {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-delete-log:hover {
            background: #dc2626;
        }

        .category-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1f2937;
        }

        .category-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .category-bar-fill {
            height: 100%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .time-logs h3 {
            margin-bottom: 20px;
            color: #1f2937;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .logs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .log-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .log-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        .log-details {
            flex: 1;
        }

        .log-category {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }


        .log-time {
            color: #9ca3af;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .log-time-period {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .log-duration {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            font-family: 'Courier New', monospace;
            min-width: 80px;
            text-align: right;
        }

        .delete-btn {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .hidden {
            display: none;
        }

        .add-category-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 100px;
        }

        .add-category-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .add-category-card .add-icon {
            font-size: 2.5rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .add-category-card:hover .add-icon {
            color: #667eea;
        }

        .add-category-card .add-text {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 600;
        }

        .add-category-card:hover .add-text {
            color: #667eea;
        }

        .btn-add {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-add:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-add:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .category-item-container {
            position: relative;
        }

        .category-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .category-item-container:hover .category-actions {
            opacity: 1;
        }

        .edit-category-btn,
        .delete-category-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .edit-category-btn:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
        }

        .delete-category-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .reset-defaults-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 80px;
        }

        .reset-defaults-card:hover {
            border-color: #9ca3af;
            background: #f3f4f6;
        }

        .reset-defaults-card .add-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .reset-defaults-card .add-text {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .category-card-wrapper {
            position: relative;
        }

        .category-subcategories {
            margin-top: 10px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border: 2px solid #bae6fd;
            display: none;
        }

        .category-subcategories.show {
            display: block;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #dbeafe; }
            100% { transform: scale(1); }
        }

        .subcategory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subcategory-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .subcategory-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .subcategory-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #bae6fd;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .subcategory-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .subcategory-input-group input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .subcategory-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .subcategory-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: white;
            border: 2px solid #bae6fd;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #1f2937;
        }

        .subcategory-tag .delete-subcategory {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .subcategory-tag .delete-subcategory:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .subcategory-selector {
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .subcategory-selector label {
            display: block;
            margin-bottom: 8px;
            color: #1f2937;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .subcategory-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        .subcategory-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .subcategory-selector select:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .manual-entry-section {
            margin-top: 30px;
            padding: 20px;
            background: #fef3c7;
            border-radius: 12px;
            border: 2px solid #fcd34d;
        }

        .manual-entry-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .manual-entry-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .manual-entry-form .form-group {
            min-width: 120px;
        }

        .manual-entry-form input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .manual-entry-form input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-input-group input {
            flex: 1;
        }

        .time-input-group span {
            color: #6b7280;
            font-weight: 600;
        }

        /* 24h overview */
        .overview-header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .overview-header h3 {
            color: #1f2937;
            font-size: 1.2rem;
        }

        .overview-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .overview-controls label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .overview-controls input[type="date"] {
            padding: 8px 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        .timeline {
            position: relative;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .timeline-grid {
            position: relative;
            height: 720px; /* 24h * 30px = half-scale for clarity */
        }

        .timeline-hour {
            position: absolute;
            left: 0;
            right: 0;
            height: 60px;
            border-top: 1px solid #eef2f7;
            display: flex;
            align-items: flex-start;
        }

        .timeline-hour-label {
            width: 64px;
            padding: 6px 8px;
            font-size: 0.85rem;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }

        .timeline-hour-line {
            flex: 1;
            height: 100%;
        }

        .timeline-events {
            position: absolute;
            top: 0;
            left: 72px;
            right: 10px;
            bottom: 0;
        }

        .timeline-event {
            position: absolute;
            left: 0;
            right: 0;
            border-radius: 10px;
            padding: 10px 12px;
            color: #111827;
            background: rgba(59, 130, 246, 0.12);
            border: 2px solid rgba(59, 130, 246, 0.35);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timeline-event-time {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 3px;
        }

        .timeline-event-category {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeline-event-category .cat-icon {
            font-size: 1.1rem;
        }

        .timeline-event-sub {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 3px;
        }

        .timeline-event-duration {
            font-size: 0.85rem;
            font-weight: 600;
            color: #059669;
            background: rgba(5, 150, 105, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            width: fit-content;
        }

        .timeline-event-meta {
            font-size: 0.85rem;
            color: #374151;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .timeline-empty {
            padding: 30px;
            text-align: center;
            color: #6b7280;
        }

        /* Overview Table Styles */
        .overview-table-container {
            overflow-x: auto;
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .overview-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .overview-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .overview-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }

        .overview-table tbody tr:hover {
            background: #f9fafb;
        }

        .overview-table td {
            padding: 12px 15px;
            vertical-align: middle;
        }

        .overview-table .col-num {
            width: 40px;
            text-align: center;
            color: #9ca3af;
            font-weight: 600;
        }

        .overview-table .col-time {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }

        .overview-table .col-category {
            min-width: 120px;
        }

        .overview-table .cat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .overview-table .col-sub {
            color: #6b7280;
        }

        .overview-table .col-duration {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #059669;
            background: #ecfdf5;
            border-radius: 6px;
            text-align: center;
        }

        .overview-table tfoot {
            background: #f3f4f6;
            border-top: 2px solid #e5e7eb;
        }

        .overview-table tfoot td {
            padding: 14px 15px;
            font-weight: 700;
        }

        .overview-table .total-label {
            text-align: right;
            color: #374151;
        }

        .overview-table .total-value {
            font-family: 'Courier New', monospace;
            color: #059669;
            background: #d1fae5;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .app {
                border-radius: 0;
                min-height: 100vh;
            }

            .app-header {
                padding: 25px 20px;
            }

            .app-header h1 {
                font-size: 1.8rem;
            }

            .app-header p {
                font-size: 0.95rem;
            }

            .time {
                font-size: 2.8rem;
            }

            .tracker-container, .logs-container {
                padding: 20px;
            }

            .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .category-card {
                padding: 15px 10px;
            }

            .category-icon {
                font-size: 1.8rem;
            }

            .category-name {
                font-size: 0.8rem;
            }

            .timer-controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                padding: 15px;
                font-size: 1rem;
            }

            .stats-summary {
                grid-template-columns: 1fr;
            }

            .view-toggle button {
                padding: 12px 8px;
                font-size: 0.9rem;
            }

            .manual-entry {
                padding: 15px;
            }

            .manual-entry h4 {
                font-size: 1rem;
            }

            .manual-row {
                flex-direction: column;
                gap: 10px;
            }

            .category-selector-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .manage-btn {
                width: 100%;
                text-align: center;
            }

            .overview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .overview-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .overview-table {
                font-size: 0.8rem;
            }

            .overview-table th,
            .overview-table td {
                padding: 8px 6px;
            }

            .overview-table .cat-badge {
                padding: 3px 8px;
                font-size: 0.75rem;
            }

            .management-content {
                max-height: 95vh;
                border-radius: 12px;
            }

            .management-header h2 {
                font-size: 1.1rem;
            }

            .management-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .management-item-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .subcategory-list {
                margin-left: 10px;
            }

            /* Touch-friendly improvements */
            button, select, input {
                min-height: 44px;
            }

            .category-actions {
                opacity: 1;
            }
        }

        /* Header buttons */
        .header-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .auth-btn, .sync-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-btn:hover, .sync-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            transform: scale(1.05);
        }

        .auth-btn.logged-in {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.8);
        }

        .sync-status {
            font-size: 0.8rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        /* Auth Modal */
        .auth-modal, .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-modal.active, .config-modal.active {
            display: flex;
        }

        .auth-content, .config-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .auth-header, .config-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auth-header h2, .config-header h2 {
            font-size: 1.2rem;
            margin: 0;
        }

        .auth-close, .config-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .auth-body, .config-body {
            padding: 25px;
            overflow-y: auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f9fafb;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .auth-field {
            margin-bottom: 15px;
        }

        .auth-field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .auth-field input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .auth-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }

        .auth-divider span {
            background: white;
            padding: 0 15px;
            color: #9ca3af;
            font-size: 0.85rem;
            position: relative;
        }

        .google-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .google-btn:hover {
            border-color: #4285F4;
            background: #f8fafc;
        }

        .auth-setup-info {
            margin-top: 20px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .auth-setup-info summary {
            cursor: pointer;
            font-weight: 600;
            color: #92400e;
        }

        .auth-setup-info ol {
            margin: 10px 0 10px 20px;
            color: #78350f;
        }

        .auth-setup-info li {
            margin-bottom: 5px;
        }

        .auth-setup-info a {
            color: #2563eb;
        }

        .config-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #f59e0b;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Account view */
        .account-info {
            text-align: center;
            padding: 20px 0;
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 15px;
        }

        .account-email {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .account-sync-status {
            font-size: 0.9rem;
            color: #059669;
            padding: 8px 15px;
            background: #d1fae5;
            border-radius: 20px;
            display: inline-block;
        }

        .account-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .sync-now-btn, .logout-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sync-now-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .logout-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .last-sync {
            text-align: center;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Config modal */
        .config-body textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            margin: 10px 0;
            resize: vertical;
        }

        .save-config-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .config-note {
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 10px;
        }

        /* Sync button */
        .sync-btn {
            margin-top: 12px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sync-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            transform: scale(1.05);
        }

        /* Sync Modal */
        .sync-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .sync-modal.active {
            display: flex;
        }

        .sync-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sync-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-header h2 {
            font-size: 1.2rem;
            margin: 0;
        }

        .sync-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .sync-body {
            padding: 20px;
            overflow-y: auto;
        }

        .sync-section {
            margin-bottom: 20px;
        }

        .sync-section h3 {
            font-size: 1rem;
            color: #374151;
            margin-bottom: 8px;
        }

        .sync-section p {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .sync-action-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .import-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
        }

        .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .copy-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .paste-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .paste-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .sync-divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .sync-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }

        .sync-divider span {
            background: white;
            padding: 0 15px;
            color: #9ca3af;
            font-size: 0.85rem;
            position: relative;
        }

        .sync-code-display {
            margin-top: 10px;
            padding: 10px;
            background: #d1fae5;
            border-radius: 8px;
            color: #059669;
            font-size: 0.85rem;
            text-align: center;
        }

        .sync-code-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: monospace;
            resize: none;
            margin-bottom: 10px;
        }

        .sync-code-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .sync-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border-left: 4px solid #0ea5e9;
        }

        .sync-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #0369a1;
        }

        /* Install button */
        .install-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 25px;
            color: #667eea;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Safe area padding for notched phones */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(env(safe-area-inset-left), 0px);
                padding-right: max(env(safe-area-inset-right), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
            }
        }

        /* Prevent text selection on buttons for touch */
        button {
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="app-header">
            <h1>⏳ Hourglass</h1>
            <p class="slogan">Watch time pass, choose how to live.</p>
            <div class="header-buttons">
                <button id="authBtn" class="auth-btn" onclick="openAuthModal()">👤 Login</button>
                <button class="sync-btn" onclick="openSyncModal()">🔄 Sync</button>
            </div>
            <div id="syncStatus" class="sync-status"></div>
        </header>

        <div class="view-toggle">
            <button id="trackerBtn" class="active" onclick="switchView('tracker')">Timer</button>
            <button id="logsBtn" onclick="switchView('logs')">Logs & Stats</button>
        </div>

        <!-- Tracker View -->
        <div id="trackerView" class="tracker-container">
            <div class="timer-display">
                <div class="time" id="timeDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-start" onclick="startTimer()">▶ Start</button>
                    <button id="stopBtn" class="btn btn-stop hidden" onclick="stopTimer()">⏹ Stop & Save</button>
                    <button id="resetBtn" class="btn btn-reset hidden" onclick="resetTimer()">↻ Reset</button>
                </div>
            </div>

            <div class="category-selector">
                <div class="category-selector-header">
                    <h3>Select Category</h3>
                    <button class="manage-btn" onclick="openManagementModal()">⚙️ Manage</button>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>

            <div id="activeTimerInfo" class="active-timer-info hidden">
                <p>Tracking: <strong id="activeCategoryName"></strong></p>
            </div>

            <div class="manual-entry-section">
                <h3>📝 Manual Entry (Add Record Without Timer)</h3>
                <div class="manual-entry-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="manualCategory">Category</label>
                        <select id="manualCategory" onchange="updateManualSubcategoryDropdown()" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;">
                            <!-- Categories will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="manualSubcategory">Subcategory (optional)</label>
                        <select id="manualSubcategory" onchange="handleManualSubcategoryChange()" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;">
                            <option value="">-- No subcategory --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manualStartTime">Start time</label>
                        <div class="time-input-group">
                            <select id="manualStartHour" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;"></select>
                            <span>:</span>
                            <select id="manualStartMinute" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="manualEndTime">End time</label>
                        <div class="time-input-group">
                            <select id="manualEndHour" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;"></select>
                            <span>:</span>
                            <select id="manualEndMinute" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;"></select>
                        </div>
                    </div>
                </div>
                <button class="btn btn-add" onclick="addManualEntry()" style="width: 100%; margin-top: 10px; padding: 12px;">
                    ➕ Add Record
                </button>
            </div>
        </div>

        <!-- Logs View -->
        <div id="logsView" class="logs-container hidden">
            <div class="stats-summary">
                <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end; margin-bottom: 8px;">
                    <label for="statsRange" style="font-size: 0.85rem; color: #4b5563; font-weight: 600; margin-right: 6px;">Range</label>
                    <select id="statsRange" onchange="updateLogsView()" style="padding: 6px 10px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 0.85rem;">
                        <option value="day">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayTotal">00:00:00</div>
                    <div class="stat-label" id="statsRangeLabel">Selected Range Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
            </div>

            <div class="category-stats">
                <h3>Time by Category</h3>
                <div class="category-bars" id="categoryBars"></div>
            </div>

            <div class="time-logs">
                <h3>Recent Activity</h3>
                <div id="logsList" class="logs-list"></div>
            </div>

            <!-- Overview Section (integrated) -->
            <div class="overview-section">
                <div class="overview-header">
                    <h3>📊 Overview</h3>
                    <div class="overview-controls">
                        <label for="overviewDate">Date</label>
                        <input id="overviewDate" type="date" onchange="renderOverview()" />
                        <label for="overviewRange">View</label>
                        <select id="overviewRange" onchange="renderOverview()" style="padding: 6px 10px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 0.85rem;">
                            <option value="day">Day (24h)</option>
                            <option value="week">Week</option>
                            <option value="month">Month</option>
                            <option value="year">Year</option>
                        </select>
                    </div>
                </div>
                <div class="timeline">
                    <div id="timelineGrid" class="timeline-grid"></div>
                </div>
                <div id="overviewSummary" class="logs-list" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Category Details -->
    <div id="categoryModal" class="modal-overlay hidden" onclick="closeCategoryModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Category Details</h3>
                <button class="close-modal" onclick="closeCategoryModal()">✕</button>
            </div>
            <div id="categoryModalBody">
                <!-- Logs will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal" onclick="closeAuthModal(event)">
        <div class="auth-content" onclick="event.stopPropagation()">
            <div class="auth-header">
                <h2 id="authTitle">👤 Login / Sign Up</h2>
                <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            </div>
            <div class="auth-body">
                <!-- Not logged in view -->
                <div id="authLoginView">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
                    </div>
                    
                    <form id="authForm" onsubmit="handleAuthSubmit(event)">
                        <div class="auth-field">
                            <label>Email</label>
                            <input type="email" id="authEmail" required placeholder="your@email.com">
                        </div>
                        <div class="auth-field">
                            <label>Password</label>
                            <input type="password" id="authPassword" required placeholder="••••••••" minlength="6">
                        </div>
                        <button type="submit" class="auth-submit-btn" id="authSubmitBtn">Login</button>
                    </form>

                    <div class="auth-divider"><span>or</span></div>

                    <button class="google-btn" onclick="signInWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
                        Continue with Google
                    </button>

                    <div class="auth-setup-info">
                        <details>
                            <summary>⚙️ First time? Set up Firebase (one-time)</summary>
                            <ol>
                                <li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                                <li>Create a new project (free)</li>
                                <li>Enable Authentication → Email/Password & Google</li>
                                <li>Create Firestore Database</li>
                                <li>Get your config from Project Settings</li>
                                <li>Click "Configure Firebase" below</li>
                            </ol>
                            <button class="config-btn" onclick="showFirebaseConfig()">🔧 Configure Firebase</button>
                        </details>
                    </div>
                </div>

                <!-- Logged in view -->
                <div id="authAccountView" style="display:none;">
                    <div class="account-info">
                        <div class="account-avatar" id="accountAvatar">👤</div>
                        <div class="account-email" id="accountEmail">user@email.com</div>
                        <div class="account-sync-status" id="accountSyncStatus">
                            ✅ Auto-sync enabled
                        </div>
                    </div>
                    <div class="account-actions">
                        <button class="sync-now-btn" onclick="syncToCloud()">🔄 Sync Now</button>
                        <button class="logout-btn" onclick="logoutUser()">🚪 Logout</button>
                    </div>
                    <div class="last-sync" id="lastSyncTime">Last synced: Never</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Config Modal -->
    <div id="firebaseConfigModal" class="config-modal" onclick="closeFirebaseConfig(event)">
        <div class="config-content" onclick="event.stopPropagation()">
            <div class="config-header">
                <h2>🔧 Firebase Configuration</h2>
                <button class="config-close" onclick="closeFirebaseConfig()">&times;</button>
            </div>
            <div class="config-body">
                <p>Paste your Firebase config object here:</p>
                <textarea id="firebaseConfigInput" rows="10" placeholder='{
  "apiKey": "your-api-key",
  "authDomain": "your-project.firebaseapp.com",
  "projectId": "your-project-id",
  "storageBucket": "your-project.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "your-app-id"
}'></textarea>
                <button class="save-config-btn" onclick="saveFirebaseConfig()">💾 Save Configuration</button>
                <p class="config-note">Your config is stored locally and never shared.</p>
            </div>
        </div>
    </div>

    <!-- Sync Modal -->
    <div id="syncModal" class="sync-modal" onclick="closeSyncModal(event)">
        <div class="sync-content" onclick="event.stopPropagation()">
            <div class="sync-header">
                <h2>🔄 Sync Data Across Devices</h2>
                <button class="sync-close" onclick="closeSyncModal()">&times;</button>
            </div>
            <div class="sync-body">
                <div class="sync-section">
                    <h3>📤 Export Data</h3>
                    <p>Download all your data as a file. You can then import it on another device.</p>
                    <button class="sync-action-btn export-btn" onclick="exportData()">
                        📥 Download Data File
                    </button>
                </div>

                <div class="sync-section">
                    <h3>📥 Import Data</h3>
                    <p>Upload a data file from another device to sync your records.</p>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="sync-action-btn import-btn" onclick="document.getElementById('importFile').click()">
                        📤 Upload Data File
                    </button>
                </div>

                <div class="sync-divider">
                    <span>OR Quick Sync</span>
                </div>

                <div class="sync-section">
                    <h3>📋 Copy Sync Code</h3>
                    <p>Copy this code and paste it on your other device.</p>
                    <button class="sync-action-btn copy-btn" onclick="copySyncCode()">
                        📋 Copy Sync Code
                    </button>
                    <div id="syncCodeDisplay" class="sync-code-display" style="display:none;">
                        <small>Code copied! Valid for import on another device.</small>
                    </div>
                </div>

                <div class="sync-section">
                    <h3>📝 Paste Sync Code</h3>
                    <p>Paste a sync code from another device to import data.</p>
                    <textarea id="syncCodeInput" class="sync-code-input" placeholder="Paste sync code here..." rows="3"></textarea>
                    <button class="sync-action-btn paste-btn" onclick="importSyncCode()">
                        ✅ Import from Code
                    </button>
                </div>

                <div class="sync-info">
                    <p>💡 <strong>Tip:</strong> For automatic sync, consider using cloud storage services like Google Drive or Dropbox to store your exported data file.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="management-modal" onclick="closeManagementModal(event)">
        <div class="management-content" onclick="event.stopPropagation()">
            <div class="management-header">
                <h2>⚙️ Manage Categories & Subcategories</h2>
                <button class="management-close" onclick="closeManagementModal()">&times;</button>
            </div>
            <div class="management-body" id="managementBody">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_CATEGORIES = [
            { id: 'work', name: 'Working', color: '#3b82f6', icon: '💼', isCustom: false, subcategories: ['Full-time job', 'Part-time job', 'Freelance', 'Meeting'] },
            { id: 'learning', name: 'Learning', color: '#10b981', icon: '📚', isCustom: false, subcategories: ['Academic learning', 'Skill training', 'Online course', 'Language study'] },
            { id: 'reading', name: 'Reading', color: '#6366f1', icon: '📖', isCustom: false, subcategories: ['Books', 'Articles', 'News', 'Research'] },
            { id: 'sports', name: 'Sports', color: '#f59e0b', icon: '🏃', isCustom: false, subcategories: ['Running', 'Gym', 'Swimming', 'Cycling', 'Yoga'] },
            { id: 'housework', name: 'Housework', color: '#14b8a6', icon: '🏠', isCustom: false, subcategories: ['Cleaning', 'Cooking', 'Laundry', 'Shopping'] },
            { id: 'entertainment', name: 'Entertainment', color: '#ef4444', icon: '🎮', isCustom: false, subcategories: ['Gaming', 'Movies', 'Music', 'Social media'] },
            { id: 'social', name: 'Social', color: '#8b5cf6', icon: '👥', isCustom: false, subcategories: ['Family', 'Friends', 'Dating', 'Networking'] },
            { id: 'rest', name: 'Rest', color: '#06b6d4', icon: '😴', isCustom: false, subcategories: ['Sleep', 'Nap', 'Relaxation', 'Meditation'] },
        ];

        let customCategories = [];
        let customSubcategories = {}; // { categoryId: ['custom sub 1', 'custom sub 2'] }
        let modifiedDefaults = {}; // { categoryId: { name: 'New Name', ... } }
        let deletedDefaults = []; // ['work', 'learning', ...]
        let activeTimer = null;
        let elapsedTime = 0;
        let timeLogs = [];
        let selectedCategory = 'work';
        let selectedSubcategory = null;
        let timerInterval = null;

        // Get all categories (default + custom), applying modifications and excluding deleted
        function getAllCategories() {
            const defaults = DEFAULT_CATEGORIES
                .filter(c => !deletedDefaults.includes(c.id))
                .map(c => {
                    if (modifiedDefaults[c.id]) {
                        return { ...c, ...modifiedDefaults[c.id] };
                    }
                    return c;
                });
            return [...defaults, ...customCategories];
        }

        // Load modified defaults from localStorage
        function loadModifiedDefaults() {
            const saved = localStorage.getItem('modifiedDefaults');
            if (saved) {
                modifiedDefaults = JSON.parse(saved);
            }
        }

        // Save modified defaults to localStorage
        function saveModifiedDefaults() {
            localStorage.setItem('modifiedDefaults', JSON.stringify(modifiedDefaults));
        }

        // Load deleted defaults from localStorage
        function loadDeletedDefaults() {
            const saved = localStorage.getItem('deletedDefaults');
            if (saved) {
                deletedDefaults = JSON.parse(saved);
            }
        }

        // Save deleted defaults to localStorage
        function saveDeletedDefaults() {
            localStorage.setItem('deletedDefaults', JSON.stringify(deletedDefaults));
        }

        // Reset all categories to defaults
        function resetToDefaults() {
            if (!confirm('Reset all categories and subcategories to defaults? This will:\n- Restore deleted default categories\n- Restore deleted default subcategories\n- Revert name changes to default categories\n- Keep your custom categories and subcategories\n- Keep your time logs\n\nContinue?')) {
                return;
            }
            modifiedDefaults = {};
            deletedDefaults = [];
            saveModifiedDefaults();
            saveDeletedDefaults();
            
            // Clear hidden subcategories
            localStorage.removeItem('hiddenSubcategories');
            
            // Reset selected category if it was deleted
            const allCats = getAllCategories();
            if (!allCats.find(c => c.id === selectedCategory)) {
                selectedCategory = allCats[0]?.id || 'work';
            }
            
            renderCategories();
            updateManualCategoryDropdown();
            alert('Default categories and subcategories have been restored!');
        }

        // Get all subcategories for a category (predefined + custom)
        function getAllSubcategories(categoryId) {
            const category = getAllCategories().find(c => c.id === categoryId);
            const allPredefined = category?.subcategories || [];
            const hiddenSubs = JSON.parse(localStorage.getItem('hiddenSubcategories') || '{}');
            const hidden = hiddenSubs[categoryId] || [];
            const predefined = allPredefined.filter(sub => !hidden.includes(sub));
            const custom = customSubcategories[categoryId] || [];
            return [...predefined, ...custom];
        }

        // Load custom subcategories from localStorage
        function loadCustomSubcategories() {
            const saved = localStorage.getItem('customSubcategories');
            if (saved) {
                customSubcategories = JSON.parse(saved);
            }
        }

        // Save custom subcategories to localStorage
        function saveCustomSubcategories() {
            localStorage.setItem('customSubcategories', JSON.stringify(customSubcategories));
        }

        // Add custom subcategory
        function addCustomSubcategory(categoryId, subName) {
            if (!customSubcategories[categoryId]) {
                customSubcategories[categoryId] = [];
            }
            const trimmed = subName.trim();
            if (trimmed && !customSubcategories[categoryId].includes(trimmed)) {
                // Also check if it's not in predefined
                const category = getAllCategories().find(c => c.id === categoryId);
                const predefined = category?.subcategories || [];
                if (!predefined.includes(trimmed)) {
                    customSubcategories[categoryId].push(trimmed);
                    saveCustomSubcategories();
                    return true;
                }
            }
            return false;
        }

        // Edit custom subcategory
        function editCustomSubcategory(categoryId, oldName) {
            const newName = prompt('Edit subcategory name:', oldName);
            if (newName && newName.trim() && newName.trim() !== oldName) {
                const trimmed = newName.trim();
                // Check if new name already exists
                const allSubs = getAllSubcategories(categoryId);
                if (allSubs.includes(trimmed)) {
                    alert('A subcategory with this name already exists.');
                    return;
                }
                
                // Update in customSubcategories
                if (customSubcategories[categoryId]) {
                    const idx = customSubcategories[categoryId].indexOf(oldName);
                    if (idx !== -1) {
                        customSubcategories[categoryId][idx] = trimmed;
                        saveCustomSubcategories();
                        
                        // Update in existing logs
                        timeLogs.forEach(log => {
                            if (log.category === categoryId && log.subcategory === oldName) {
                                log.subcategory = trimmed;
                            }
                        });
                        saveLogs();
                        
                        // Update selected subcategory if it was the one being edited
                        if (selectedSubcategory === oldName) {
                            selectedSubcategory = trimmed;
                        }
                        
                        renderCategories();
                        updateManualCategoryDropdown();
                    }
                }
            }
        }

        // Delete custom subcategory
        function deleteCustomSubcategory(categoryId, subName) {
            if (!confirm(`Delete subcategory "${subName}"? This will remove it from the list but existing logs will keep this subcategory.`)) {
                return;
            }
            
            if (customSubcategories[categoryId]) {
                customSubcategories[categoryId] = customSubcategories[categoryId].filter(s => s !== subName);
                saveCustomSubcategories();
                
                // Reset selected subcategory if it was the one being deleted
                if (selectedSubcategory === subName) {
                    selectedSubcategory = null;
                }
                
                renderCategories();
                updateManualCategoryDropdown();
            }
        }

        // Check if subcategory is custom (not predefined)
        function isCustomSubcategory(categoryId, subName) {
            return customSubcategories[categoryId]?.includes(subName) || false;
        }

        // Initialize
        function init() {
            loadCustomCategories();
            loadCustomSubcategories();
            loadModifiedDefaults();
            loadDeletedDefaults();
            loadLogs();
            
            // Ensure selected category exists
            const allCats = getAllCategories();
            if (!allCats.find(c => c.id === selectedCategory)) {
                selectedCategory = allCats[0]?.id || 'work';
            }
            
            renderCategories();
            updateLogsView();
            updateManualCategoryDropdown();
            initManualTimeSelects();
            // Initialize overview date default
            const overviewDate = document.getElementById('overviewDate');
            if (overviewDate && !overviewDate.value) {
                overviewDate.value = toLocalDateInputValue(new Date());
            }
        }

        function initManualTimeSelects() {
            const sh = document.getElementById('manualStartHour');
            const sm = document.getElementById('manualStartMinute');
            const eh = document.getElementById('manualEndHour');
            const em = document.getElementById('manualEndMinute');
            if (!sh || !sm || !eh || !em) return;

            sh.innerHTML = '';
            eh.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                const opt = `<option value="${h}">${pad2(h)}</option>`;
                sh.insertAdjacentHTML('beforeend', opt);
                eh.insertAdjacentHTML('beforeend', opt);
            }

            sm.innerHTML = '';
            em.innerHTML = '';
            for (let m = 0; m < 60; m += 5) {
                const opt = `<option value="${m}">${pad2(m)}</option>`;
                sm.insertAdjacentHTML('beforeend', opt);
                em.insertAdjacentHTML('beforeend', opt);
            }

            const now = new Date();
            const round5 = Math.floor(now.getMinutes() / 5) * 5;
            sh.value = String(now.getHours());
            sm.value = String(round5);
            // default end = +30min
            const end = new Date(now.getTime() + 30 * 60000);
            const endRound5 = Math.floor(end.getMinutes() / 5) * 5;
            eh.value = String(end.getHours());
            em.value = String(endRound5);
        }

        // Load custom categories from localStorage
        function loadCustomCategories() {
            const saved = localStorage.getItem('customCategories');
            if (saved) {
                customCategories = JSON.parse(saved);
            }
        }

        // Save custom categories to localStorage
        function saveCustomCategories() {
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
        }

        // Load logs from localStorage
        function loadLogs() {
            const saved = localStorage.getItem('timeLogs');
            if (saved) {
                timeLogs = JSON.parse(saved);
            }
        }

        // Save logs to localStorage
        function saveLogs() {
            localStorage.setItem('timeLogs', JSON.stringify(timeLogs));
        }

        // Render category cards
        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            const allCategories = getAllCategories();
            const categoriesHtml = allCategories.map(category => {
                const isSelected = selectedCategory === category.id;
                const subs = getAllSubcategories(category.id);
                
                // Build subcategory options
                let subOptions = '<option value="">-- No subcategory --</option>';
                subs.forEach(sub => {
                    const selected = selectedSubcategory === sub ? 'selected' : '';
                    subOptions += `<option value="${sub}" ${selected}>${sub}</option>`;
                });
                subOptions += '<option value="__add_new__">➕ Add new...</option>';
                
                return `
                    <div class="category-card-wrapper">
                        <button
                            class="category-card ${isSelected ? 'active' : ''}"
                            onclick="selectCategory('${category.id}')"
                            style="border-color: ${isSelected ? category.color : 'transparent'}; background-color: ${isSelected ? category.color + '15' : 'white'};"
                        >
                            <span class="category-icon">${category.icon}</span>
                            <span class="category-name">${category.name}</span>
                        </button>
                        ${isSelected && subs.length > 0 ? `
                            <div class="subcategory-panel">
                                <select onchange="selectSubcategory(this.value)" ${activeTimer ? 'disabled' : ''}>
                                    ${subOptions}
                                </select>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = categoriesHtml;
            updateManualCategoryDropdown();
        }
        
        // Update manual entry category dropdown when category is selected
        function selectCategory(categoryId) {
            if (activeTimer) return; // Can't change category while timer is running
            selectedCategory = categoryId;
            selectedSubcategory = null; // Reset subcategory when changing category
            renderCategories();
            updateManualCategoryDropdown();
        }

        // Select subcategory
        function selectSubcategory(value) {
            if (activeTimer) return;
            
            if (value === '__add_new__') {
                const newSub = prompt('Enter new subcategory name:');
                if (newSub && newSub.trim()) {
                    if (addCustomSubcategory(selectedCategory, newSub.trim())) {
                        selectedSubcategory = newSub.trim();
                        renderCategories();
                    } else {
                        alert('Subcategory already exists or is invalid.');
                        selectedSubcategory = null;
                        renderCategories();
                    }
                } else {
                    selectedSubcategory = null;
                    renderCategories();
                }
            } else {
                selectedSubcategory = value || null;
            }
        }

        // Format time
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Prefer calculating duration from recorded time period (endTime - startTime).
        // Fallback to stored duration for older records.
        function getDurationSeconds(log) {
            const start = Number(log.startTime);
            const end = Number(log.endTime);
            if (Number.isFinite(start) && Number.isFinite(end) && end >= start) {
                return Math.max(0, Math.floor((end - start) / 1000));
            }
            return Number(log.duration) || 0;
        }

        // Start timer
        function startTimer() {
            if (activeTimer) return;
            activeTimer = Date.now();
            elapsedTime = 0;
            updateTimeDisplay();
            
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');
            document.getElementById('activeTimerInfo').classList.remove('hidden');
            
            const category = getAllCategories().find(c => c.id === selectedCategory);
            document.getElementById('activeCategoryName').textContent = category.name;

            timerInterval = setInterval(() => {
                // Calculate from real time to avoid drift / tab sleep issues
                elapsedTime = Math.max(0, Math.floor((Date.now() - activeTimer) / 1000));
                updateTimeDisplay();
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (!activeTimer) return;
            
            clearInterval(timerInterval);
            // Calculate from real time to ensure accuracy
            const duration = Math.max(0, Math.floor((Date.now() - activeTimer) / 1000));
            const category = getAllCategories().find(c => c.id === selectedCategory);
            
            const newLog = {
                id: Date.now(),
                category: selectedCategory,
                categoryName: category.name,
                categoryColor: category.color,
                categoryIcon: category.icon,
                subcategory: selectedSubcategory || null,
                duration: duration,
                startTime: activeTimer,
                endTime: Date.now(),
                date: new Date().toISOString(),
                isManualEntry: false,
            };
            
            timeLogs.unshift(newLog);
            saveLogs();
            
            resetTimer();
            updateLogsView();
        }

        // Reset timer
        function resetTimer() {
            clearInterval(timerInterval);
            activeTimer = null;
            elapsedTime = 0;
            selectedSubcategory = null;
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('activeTimerInfo').classList.add('hidden');
            
            updateTimeDisplay();
            renderCategories();
        }

        // Update time display
        function updateTimeDisplay() {
            document.getElementById('timeDisplay').textContent = formatTime(elapsedTime);
        }

        // Switch view
        function switchView(view) {
            const trackerView = document.getElementById('trackerView');
            const logsView = document.getElementById('logsView');
            const trackerBtn = document.getElementById('trackerBtn');
            const logsBtn = document.getElementById('logsBtn');

            trackerView.classList.add('hidden');
            logsView.classList.add('hidden');
            trackerBtn.classList.remove('active');
            logsBtn.classList.remove('active');

            if (view === 'tracker') {
                trackerView.classList.remove('hidden');
                trackerBtn.classList.add('active');
            } else {
                logsView.classList.remove('hidden');
                logsBtn.classList.add('active');
                updateLogsView();
                renderOverview();
            }
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function toLocalDateInputValue(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        }

        function getDayBoundsFromInput(dateStr) {
            // dateStr in YYYY-MM-DD, interpret as local day
            const [y, m, d] = dateStr.split('-').map(Number);
            const start = new Date(y, m - 1, d, 0, 0, 0, 0);
            const end = new Date(y, m - 1, d + 1, 0, 0, 0, 0);
            return { start, end };
        }

        function formatHM(ts) {
            const d = new Date(ts);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function splitLogToDaySegments(log, dayStartMs, dayEndMs) {
            const start = Number(log.startTime);
            const end = Number(log.endTime);
            if (!Number.isFinite(start) || !Number.isFinite(end) || end <= start) return [];

            const segStart = clamp(start, dayStartMs, dayEndMs);
            const segEnd = clamp(end, dayStartMs, dayEndMs);
            if (segEnd <= segStart) return [];

            return [{
                log,
                startMs: segStart,
                endMs: segEnd
            }];
        }

        function renderOverview() {
            const dateInput = document.getElementById('overviewDate');
            const grid = document.getElementById('timelineGrid');
            const summary = document.getElementById('overviewSummary');
            const rangeSelect = document.getElementById('overviewRange');
            if (!dateInput || !grid) return;

            // default date to today
            if (!dateInput.value) {
                dateInput.value = toLocalDateInputValue(new Date());
            }

            const baseStr = dateInput.value;
            const [y, m, d] = baseStr.split('-').map(Number);
            const baseDate = new Date(y, m - 1, d);
            const range = rangeSelect ? rangeSelect.value : 'day';

            // Clear summary initially
            if (summary) summary.innerHTML = '';

            // Day view: show as a clear table/chart
            if (range === 'day') {
                const { start, end } = getDayBoundsFromInput(baseStr);
                const dayStartMs = start.getTime();
                const dayEndMs = end.getTime();

                // Collect segments within this day
                let segments = [];
                timeLogs.forEach(log => {
                    const parts = splitLogToDaySegments(log, dayStartMs, dayEndMs);
                    segments = segments.concat(parts);
                });

                // Sort by start time
                segments.sort((a, b) => a.startMs - b.startMs);

                if (segments.length === 0) {
                    grid.innerHTML = `<div class="timeline-empty">No records for this day.</div>`;
                    return;
                }

                // Calculate total time
                let totalSeconds = 0;
                segments.forEach(({ startMs, endMs }) => {
                    totalSeconds += Math.floor((endMs - startMs) / 1000);
                });

                // Build table
                let tableHtml = `
                    <div class="overview-table-container">
                        <table class="overview-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Time Period</th>
                                    <th>Category</th>
                                    <th>Subcategory</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                segments.forEach(({ log, startMs, endMs }, index) => {
                    const catName = log.categoryName || 'Unknown';
                    const catIcon = log.categoryIcon || '📌';
                    const catColor = log.categoryColor || '#6b7280';
                    const period = `${formatHM(startMs)} - ${formatHM(endMs)}`;
                    const durationSec = Math.floor((endMs - startMs) / 1000);
                    const dur = formatTime(durationSec);

                    tableHtml += `
                        <tr>
                            <td class="col-num">${index + 1}</td>
                            <td class="col-time">${period}</td>
                            <td class="col-category">
                                <span class="cat-badge" style="background: ${catColor}22; border-color: ${catColor};">
                                    ${catIcon} ${catName}
                                </span>
                            </td>
                            <td class="col-sub">${log.subcategory || '-'}</td>
                            <td class="col-duration">${dur}</td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="total-label">Total (${segments.length} records)</td>
                                    <td class="total-value">${formatTime(totalSeconds)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                grid.innerHTML = tableHtml;
                if (summary) summary.innerHTML = '';
                return;
            }

            // For week / month / year: show a clear textual overview by date
            grid.innerHTML = `<div class="timeline-empty">Select 'Day (24h)' to see the 24h timeline. Below is a summary for the chosen range.</div>`;

            // Compute range bounds based on base date
            let rangeStart, rangeEnd;
            if (range === 'week') {
                const day = baseDate.getDay(); // 0 Sun - 6 Sat
                const diffToMonday = (day === 0 ? -6 : 1 - day);
                rangeStart = new Date(baseDate);
                rangeStart.setDate(baseDate.getDate() + diffToMonday);
                rangeStart.setHours(0, 0, 0, 0);
                rangeEnd = new Date(rangeStart);
                rangeEnd.setDate(rangeStart.getDate() + 7);
            } else if (range === 'month') {
                rangeStart = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1, 0, 0, 0, 0);
                rangeEnd = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 1, 0, 0, 0, 0);
            } else if (range === 'year') {
                rangeStart = new Date(baseDate.getFullYear(), 0, 1, 0, 0, 0, 0);
                rangeEnd = new Date(baseDate.getFullYear() + 1, 0, 1, 0, 0, 0, 0);
            } else {
                // Fallback to week if unknown
                rangeStart = new Date(baseDate);
                rangeStart.setHours(0, 0, 0, 0);
                rangeEnd = new Date(rangeStart);
                rangeEnd.setDate(rangeStart.getDate() + 1);
            }

            const startMs = rangeStart.getTime();
            const endMs = rangeEnd.getTime();

            // Filter logs by range using end time
            const logsInRange = timeLogs.filter(log => {
                const endMsLog = getLogEndTimeMs(log);
                return Number.isFinite(endMsLog) && endMsLog >= startMs && endMsLog < endMs;
            });

            if (!summary) return;
            if (logsInRange.length === 0) {
                summary.innerHTML = '<div class="empty-state">No records for this range.</div>';
                return;
            }

            // Group by date
            const byDate = {};
            logsInRange.forEach(log => {
                const end = getLogEndTimeMs(log);
                const dKey = new Date(end).toDateString();
                if (!byDate[dKey]) byDate[dKey] = [];
                byDate[dKey].push(log);
            });

            const dateKeys = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));
            summary.innerHTML = dateKeys.map(key => {
                const logs = byDate[key].slice().sort((a, b) => a.startTime - b.startTime);
                const dayTotal = logs.reduce((sum, log) => sum + getDurationSeconds(log), 0);
                const dayLabel = new Date(key).toLocaleDateString();
                const itemsHtml = logs.map(log => {
                    const start = formatHM(log.startTime);
                    const end = formatHM(log.endTime);
                    const dur = formatTime(getDurationSeconds(log));
                    const title = log.categoryName || 'Unknown';
                    const subLabel = log.subcategory ? ` › ${log.subcategory}` : '';
                    return `
                        <div class="log-item" style="background:#f9fafb;">
                            <div class="log-details">
                                <div class="log-category">${start} – ${end} · ${title}${subLabel}</div>
                            </div>
                            <div class="log-duration">${dur}</div>
                        </div>
                    `;
                }).join('');
                return `
                    <div style="margin-top: 12px;">
                        <div style="font-weight:700;color:#111827;margin-bottom:4px;">
                            ${dayLabel} · ${formatTime(dayTotal)}
                        </div>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');
        }

        function getStatsRangeBounds(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfToday = today.getTime();
            if (range === 'day') {
                return { startMs: startOfToday, endMs: startOfToday + 24 * 3600 * 1000 };
            }
            if (range === 'week') {
                const day = today.getDay(); // 0 Sun - 6 Sat
                const diffToMonday = (day === 0 ? -6 : 1 - day); // Monday as start
                const start = new Date(today);
                start.setDate(today.getDate() + diffToMonday);
                const startMs = start.getTime();
                return { startMs, endMs: startMs + 7 * 24 * 3600 * 1000 };
            }
            if (range === 'month') {
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const next = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                return { startMs: start.getTime(), endMs: next.getTime() };
            }
            if (range === 'year') {
                const start = new Date(now.getFullYear(), 0, 1);
                const next = new Date(now.getFullYear() + 1, 0, 1);
                return { startMs: start.getTime(), endMs: next.getTime() };
            }
            // all time
            return { startMs: -Infinity, endMs: Infinity };
        }

        function getLogEndTimeMs(log) {
            const end = Number(log.endTime);
            if (Number.isFinite(end)) return end;
            const d = Date.parse(log.date);
            return Number.isFinite(d) ? d : 0;
        }

        // Update logs view
        function updateLogsView() {
            const rangeSelect = document.getElementById('statsRange');
            const range = rangeSelect ? rangeSelect.value : 'day';
            const { startMs, endMs: rangeEndMs } = getStatsRangeBounds(range);
            const statsLabel = document.getElementById('statsRangeLabel');
            if (statsLabel) {
                const labels = {
                    day: "Today's Total",
                    week: "This Week Total",
                    month: "This Month Total",
                    year: "This Year Total",
                    all: "All Time Total"
                };
                statsLabel.textContent = labels[range] || 'Selected Range Total';
            }

            // Filter logs by selected range using end time
            const logs = timeLogs.filter(log => {
                const end = getLogEndTimeMs(log);
                return Number.isFinite(end) && end >= startMs && end < rangeEndMs;
            });

            const totalDuration = logs.reduce((total, log) => total + getDurationSeconds(log), 0);
            
            document.getElementById('todayTotal').textContent = formatTime(totalDuration);
            document.getElementById('totalSessions').textContent = logs.length;

            // Update category stats
            const categoryTotals = {};
            
            logs.forEach(log => {
                if (!categoryTotals[log.category]) {
                    categoryTotals[log.category] = {
                        time: 0,
                        name: log.categoryName,
                        color: log.categoryColor,
                        icon: log.categoryIcon,
                    };
                }
                categoryTotals[log.category].time += getDurationSeconds(log);
            });

            const maxTime = Math.max(...Object.values(categoryTotals).map(d => d.time), 1);
            const categoryBars = document.getElementById('categoryBars');
            
            if (Object.keys(categoryTotals).length === 0) {
                categoryBars.innerHTML = '<div class="empty-state">No data yet. Start tracking your time!</div>';
            } else {
                categoryBars.innerHTML = Object.entries(categoryTotals)
                    .sort((a, b) => b[1].time - a[1].time)
                    .map(([categoryId, data]) => `
                        <div class="category-bar-item" onclick="openCategoryModal('${categoryId}')">
                            <div class="category-bar-header">
                                <span>${data.icon} ${data.name}</span>
                                <span>${formatTime(data.time)}</span>
                            </div>
                            <div class="category-bar">
                                <div class="category-bar-fill" style="width: ${(data.time / maxTime) * 100}%; background-color: ${data.color};"></div>
                            </div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-top: 6px;">Click to view & edit details</div>
                        </div>
                    `).join('');
            }

            // Update logs list
            const logsList = document.getElementById('logsList');
            if (timeLogs.length === 0) {
                logsList.innerHTML = '<div class="empty-state"><p>No time logs yet. Start tracking your time!</p></div>';
            } else {
                const latestThree = [...timeLogs]
                    .sort((a, b) => getLogEndTimeMs(b) - getLogEndTimeMs(a))
                    .slice(0, 3);

                logsList.innerHTML = latestThree.map(log => {
                    const startTime = new Date(log.startTime);
                    const endTime = new Date(log.endTime);
                    const dateStr = startTime.toLocaleDateString();
                    const startTimeStr = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const endTimeStr = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const durationSeconds = getDurationSeconds(log);
                    
                    const subLabel = log.subcategory ? ` › ${log.subcategory}` : '';
                    return `
                    <div class="log-item">
                        <div class="log-icon" style="color: ${log.categoryColor}">${log.categoryIcon}</div>
                        <div class="log-details">
                            <div class="log-category">
                                ${log.categoryName}${subLabel}
                                ${log.isManualEntry ? '<span style="font-size: 0.75rem; color: #6b7280; margin-left: 5px;">(Manual)</span>' : ''}
                            </div>
                            <div class="log-time-period">${startTimeStr} - ${endTimeStr}</div>
                            <div class="log-time">${dateStr}</div>
                        </div>
                        <div class="log-duration">${formatTime(durationSeconds)}</div>
                        <button class="delete-btn" onclick="deleteLog(${log.id})" title="Delete">🗑️</button>
                    </div>
                `;
                }).join('');
            }
        }

        // Delete log
        function deleteLog(id) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                timeLogs = timeLogs.filter(log => log.id !== id);
                saveLogs();
                updateLogsView();
            }
        }

        // Show prompt to add custom category
        function showAddCategoryPrompt() {
            if (activeTimer) {
                alert('Cannot add category while timer is running');
                return;
            }
            
            const name = prompt('Enter category name:');
            
            if (!name || !name.trim()) {
                return; // User cancelled or entered nothing
            }
            
            const trimmedName = name.trim();
            
            // Check if name already exists
            const allCategories = getAllCategories();
            if (allCategories.some(c => c.name.toLowerCase() === trimmedName.toLowerCase())) {
                alert('A category with this name already exists');
                return;
            }
            
            // Default icon and color
            const defaultIcons = ['📝', '⭐', '🎯', '💡', '🔖', '📌', '🏷️', '✨'];
            const defaultColors = ['#6b7280', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16', '#6366f1', '#10b981'];
            
            // Use a simple hash to assign consistent icon/color based on name
            const hash = trimmedName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const icon = defaultIcons[hash % defaultIcons.length];
            const color = defaultColors[hash % defaultColors.length];
            
            const newCategory = {
                id: 'custom_' + Date.now(),
                name: trimmedName,
                icon: icon,
                color: color,
                isCustom: true
            };
            
            customCategories.push(newCategory);
            saveCustomCategories();
            
            // Re-render categories
            renderCategories();
            updateManualCategoryDropdown();
        }

        // Add manual entry
        function addManualEntry() {
            const startHour = Number(document.getElementById('manualStartHour')?.value);
            const startMinute = Number(document.getElementById('manualStartMinute')?.value);
            const endHour = Number(document.getElementById('manualEndHour')?.value);
            const endMinute = Number(document.getElementById('manualEndMinute')?.value);
            const manualCategoryId = document.getElementById('manualCategory').value;
            let manualSubcategory = document.getElementById('manualSubcategory')?.value || null;
            if (manualSubcategory === '__add_new__') manualSubcategory = null;

            if (![startHour, startMinute, endHour, endMinute].every(Number.isFinite)) {
                alert('Please select start and end time');
                return;
            }

            const base = new Date();
            base.setSeconds(0, 0);
            const startTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), startHour, startMinute, 0, 0).getTime();
            let endTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), endHour, endMinute, 0, 0).getTime();
            // If end is before start, assume it crosses midnight to next day
            if (endTime <= startTime) {
                endTime += 24 * 3600 * 1000;
            }

            const totalSeconds = Math.max(0, Math.floor((endTime - startTime) / 1000));
            if (totalSeconds === 0) {
                alert('Please ensure end time is after start time');
                return;
            }

            if (!manualCategoryId) {
                alert('Please select a category');
                return;
            }
            
            const category = getAllCategories().find(c => c.id === manualCategoryId);
            if (!category) {
                alert('Invalid category selected');
                return;
            }
            
            const newLog = {
                id: Date.now(),
                category: manualCategoryId,
                categoryName: category.name,
                categoryColor: category.color,
                categoryIcon: category.icon,
                subcategory: manualSubcategory || null,
                duration: totalSeconds,
                startTime: startTime,
                endTime: endTime,
                date: new Date(endTime).toISOString(),
                isManualEntry: true,
            };
            
            timeLogs.unshift(newLog);
            saveLogs();
            
            // Reset form
            initManualTimeSelects();
            document.getElementById('manualCategory').value = selectedCategory; // Reset to current selected category
            updateManualSubcategoryDropdown();
            
            updateLogsView();
            
            // Show success message
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✓ Added!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }
        
        // Update manual entry category dropdown
        function updateManualCategoryDropdown() {
            const select = document.getElementById('manualCategory');
            if (!select) return;
            
            const allCategories = getAllCategories();
            select.innerHTML = allCategories.map(category => 
                `<option value="${category.id}" ${category.id === selectedCategory ? 'selected' : ''}>${category.icon} ${category.name}</option>`
            ).join('');
            
            updateManualSubcategoryDropdown();
        }

        function updateManualSubcategoryDropdown() {
            const catSelect = document.getElementById('manualCategory');
            const subSelect = document.getElementById('manualSubcategory');
            if (!catSelect || !subSelect) return;
            
            const categoryId = catSelect.value;
            const subs = getAllSubcategories(categoryId);
            
            subSelect.innerHTML = '<option value="">-- No subcategory --</option>' + 
                subs.map(sub => `<option value="${sub}">${sub}</option>`).join('') +
                '<option value="__add_new__">➕ Add new...</option>';
        }

        function handleManualSubcategoryChange() {
            const catSelect = document.getElementById('manualCategory');
            const subSelect = document.getElementById('manualSubcategory');
            if (!catSelect || !subSelect) return;
            
            if (subSelect.value === '__add_new__') {
                const newSub = prompt('Enter new subcategory name:');
                if (newSub && newSub.trim()) {
                    const categoryId = catSelect.value;
                    if (addCustomSubcategory(categoryId, newSub.trim())) {
                        updateManualSubcategoryDropdown();
                        subSelect.value = newSub.trim();
                    } else {
                        alert('Subcategory already exists or is invalid.');
                        subSelect.value = '';
                    }
                } else {
                    subSelect.value = '';
                }
            }
        }

        // Delete custom category
        function deleteCategory(categoryId) {
            // Check if category is used in any logs
            const isUsed = timeLogs.some(log => log.category === categoryId);
            const isDefault = DEFAULT_CATEGORIES.some(c => c.id === categoryId);
            const category = getAllCategories().find(c => c.id === categoryId);
            
            let message = `Delete category "${category?.name || categoryId}"?`;
            if (isUsed) {
                message += '\n\nThis category is used in some time logs. Those logs will show as "Unknown Category".';
            }
            if (isDefault) {
                message += '\n\nThis is a default category. You can restore it later using "Reset to Defaults".';
            }
            
            if (!confirm(message)) {
                return;
            }
            
            if (isDefault) {
                // Mark default as deleted
                if (!deletedDefaults.includes(categoryId)) {
                    deletedDefaults.push(categoryId);
                    saveDeletedDefaults();
                }
            } else {
                // Remove custom category
                customCategories = customCategories.filter(c => c.id !== categoryId);
                saveCustomCategories();
            }
            
            // If this was the selected category, switch to first available
            if (selectedCategory === categoryId) {
                const allCategories = getAllCategories();
                if (allCategories.length > 0) {
                    selectedCategory = allCategories[0].id;
                }
            }
            
            renderCategories();
            updateManualCategoryDropdown();
        }

        // Edit category name
        function editCategory(categoryId) {
            const category = getAllCategories().find(c => c.id === categoryId);
            if (!category) return;
            
            const newName = prompt('Edit category name:', category.name);
            if (!newName || !newName.trim() || newName.trim() === category.name) {
                return;
            }
            
            const trimmed = newName.trim();
            const isDefault = DEFAULT_CATEGORIES.some(c => c.id === categoryId);
            
            if (isDefault) {
                // Store modification for default category
                if (!modifiedDefaults[categoryId]) {
                    modifiedDefaults[categoryId] = {};
                }
                modifiedDefaults[categoryId].name = trimmed;
                saveModifiedDefaults();
            } else {
                // Update custom category
                const idx = customCategories.findIndex(c => c.id === categoryId);
                if (idx !== -1) {
                    customCategories[idx].name = trimmed;
                    saveCustomCategories();
                }
            }
            
            // Update logs to reflect the new name
            timeLogs.forEach(log => {
                if (log.category === categoryId) {
                    log.categoryName = trimmed;
                }
            });
            saveLogs();
            
            renderCategories();
            updateManualCategoryDropdown();
            updateLogsView();
        }

        // Keep old function name for backward compatibility
        function deleteCustomCategory(categoryId) {
            deleteCategory(categoryId);
        }

        // Category Modal Functions
        function openCategoryModal(categoryId) {
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const body = document.getElementById('categoryModalBody');
            
            const category = getAllCategories().find(c => c.id === categoryId);
            const categoryLogs = timeLogs.filter(log => log.category === categoryId);
            
            if (!category) {
                title.textContent = 'Unknown Category';
            } else {
                title.textContent = `${category.icon} ${category.name} - Details`;
            }
            
            if (categoryLogs.length === 0) {
                body.innerHTML = '<div class="empty-state">No logs for this category.</div>';
            } else {
                // Sort by end time descending (most recent first)
                const sortedLogs = [...categoryLogs].sort((a, b) => getLogEndTimeMs(b) - getLogEndTimeMs(a));
                
                body.innerHTML = sortedLogs.map(log => {
                    const startDate = new Date(log.startTime);
                    const endDate = new Date(log.endTime);
                    const dateStr = startDate.toLocaleDateString();
                    const startH = startDate.getHours();
                    const startM = startDate.getMinutes();
                    const endH = endDate.getHours();
                    const endM = endDate.getMinutes();
                    const dur = formatTime(getDurationSeconds(log));
                    
                    // Build hour options
                    let hourOptions = '';
                    for (let h = 0; h < 24; h++) {
                        hourOptions += `<option value="${h}" ${h === startH ? 'selected' : ''}>${pad2(h)}</option>`;
                    }
                    let endHourOptions = '';
                    for (let h = 0; h < 24; h++) {
                        endHourOptions += `<option value="${h}" ${h === endH ? 'selected' : ''}>${pad2(h)}</option>`;
                    }
                    
                    // Build minute options (5-min steps)
                    let minOptions = '';
                    for (let m = 0; m < 60; m += 5) {
                        const selected = (m === Math.floor(startM / 5) * 5) ? 'selected' : '';
                        minOptions += `<option value="${m}" ${selected}>${pad2(m)}</option>`;
                    }
                    let endMinOptions = '';
                    for (let m = 0; m < 60; m += 5) {
                        const selected = (m === Math.floor(endM / 5) * 5) ? 'selected' : '';
                        endMinOptions += `<option value="${m}" ${selected}>${pad2(m)}</option>`;
                    }
                    
                    // Build category options
                    const allCats = getAllCategories();
                    let catOptions = allCats.map(c => 
                        `<option value="${c.id}" ${c.id === log.category ? 'selected' : ''}>${c.icon} ${c.name}</option>`
                    ).join('');
                    
                    // Build subcategory options
                    const subs = getAllSubcategories(log.category);
                    let subOptions = '<option value="">-- No subcategory --</option>' + 
                        subs.map(s => `<option value="${s}" ${s === log.subcategory ? 'selected' : ''}>${s}</option>`).join('') +
                        '<option value="__add_new__">➕ Add new...</option>';
                    
                    const subLabel = log.subcategory ? ` › ${log.subcategory}` : '';
                    
                    return `
                        <div class="edit-log-item" id="editLog_${log.id}">
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px;">
                                ${dateStr}${subLabel} · Duration: ${dur}
                            </div>
                            <div class="edit-log-row">
                                <label>Category</label>
                                <select id="editCat_${log.id}" onchange="updateEditSubcategoryOptions(${log.id})">${catOptions}</select>
                            </div>
                            <div class="edit-log-row">
                                <label>Subcategory</label>
                                <select id="editSub_${log.id}" onchange="handleEditSubcategoryChange(${log.id}, '${categoryId}')">${subOptions}</select>
                            </div>
                            <div class="edit-log-row">
                                <label>Start</label>
                                <select id="editStartH_${log.id}">${hourOptions}</select>
                                <span>:</span>
                                <select id="editStartM_${log.id}">${minOptions}</select>
                            </div>
                            <div class="edit-log-row">
                                <label>End</label>
                                <select id="editEndH_${log.id}">${endHourOptions}</select>
                                <span>:</span>
                                <select id="editEndM_${log.id}">${endMinOptions}</select>
                            </div>
                            <div class="edit-log-actions">
                                <button class="btn-delete-log" onclick="deleteLogFromModal(${log.id}, '${categoryId}')">🗑️ Delete</button>
                                <button class="btn-save-log" onclick="saveLogFromModal(${log.id}, '${categoryId}')">💾 Save Changes</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeCategoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('categoryModal').classList.add('hidden');
            updateLogsView(); // Refresh stats after editing
        }

        // Management Modal Functions
        function openManagementModal() {
            const modal = document.getElementById('managementModal');
            modal.classList.add('active');
            renderManagementContent();
        }

        function closeManagementModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('managementModal').classList.remove('active');
            renderCategories();
            updateManualCategoryDropdown();
        }

        function renderManagementContent() {
            const body = document.getElementById('managementBody');
            const allCategories = getAllCategories();
            
            let html = `
                <div class="management-section">
                    <h3>📁 Categories</h3>
                    <div class="management-list" id="mgmtCategoryList">
            `;
            
            allCategories.forEach(cat => {
                const subs = getAllSubcategories(cat.id);
                const customSubs = customSubcategories[cat.id] || [];
                const isDefault = DEFAULT_CATEGORIES.some(c => c.id === cat.id);
                
                html += `
                    <div class="management-item-wrapper">
                        <div class="management-item">
                            <div class="management-item-info">
                                <span class="management-item-icon">${cat.icon}</span>
                                <span class="management-item-name">${cat.name}</span>
                                ${isDefault ? '<span class="management-item-badge">Default</span>' : '<span class="management-item-badge" style="background:#dcfce7;color:#16a34a;">Custom</span>'}
                            </div>
                            <div class="management-item-actions">
                                <button class="subcategory-expand" onclick="toggleSubcategoryList('${cat.id}')">
                                    ${subs.length} subs ▼
                                </button>
                                <button class="mgmt-edit-btn" onclick="mgmtEditCategory('${cat.id}')">✏️ Edit</button>
                                <button class="mgmt-delete-btn" onclick="mgmtDeleteCategory('${cat.id}')">🗑️ Delete</button>
                            </div>
                        </div>
                        <div class="subcategory-list" id="subList_${cat.id}">
                            ${subs.map(sub => {
                                const isCustomSub = customSubs.includes(sub);
                                return `
                                    <div class="subcategory-item">
                                        <span class="subcategory-item-name">
                                            ${sub}
                                            ${isCustomSub ? '<span class="subcategory-item-badge">Custom</span>' : ''}
                                        </span>
                                        <div class="management-item-actions">
                                            <button class="mgmt-edit-btn" onclick="mgmtEditSubcategory('${cat.id}', '${sub.replace(/'/g, "\\'")}', ${isCustomSub})">✏️</button>
                                            <button class="mgmt-delete-btn" onclick="mgmtDeleteSubcategory('${cat.id}', '${sub.replace(/'/g, "\\'")}', ${isCustomSub})">🗑️</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <button class="mgmt-add-btn" onclick="mgmtAddSubcategory('${cat.id}')" style="margin-top: 8px;">
                                ➕ Add Subcategory
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <button class="mgmt-add-btn" onclick="mgmtAddCategory()" style="margin-top: 12px;">
                        ➕ Add New Category
                    </button>
                </div>
                
                <div class="management-section reset-section">
                    <button class="reset-btn" onclick="resetToDefaults(); renderManagementContent();">
                        🔄 Reset to Default Categories
                    </button>
                </div>
            `;
            
            body.innerHTML = html;
        }

        function toggleSubcategoryList(categoryId) {
            const list = document.getElementById('subList_' + categoryId);
            if (list) {
                list.classList.toggle('expanded');
            }
        }

        function mgmtAddCategory() {
            const name = prompt('Enter new category name:');
            if (name && name.trim()) {
                const icon = prompt('Enter an emoji icon for the category:', '📌') || '📌';
                const id = 'custom_' + Date.now();
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                customCategories.push({
                    id,
                    name: name.trim(),
                    color,
                    icon,
                    isCustom: true,
                    subcategories: []
                });
                saveCustomCategories();
                renderManagementContent();
            }
        }

        function mgmtEditCategory(categoryId) {
            editCategory(categoryId);
            renderManagementContent();
        }

        function mgmtDeleteCategory(categoryId) {
            deleteCategory(categoryId);
            renderManagementContent();
        }

        function mgmtAddSubcategory(categoryId) {
            const name = prompt('Enter new subcategory name:');
            if (name && name.trim()) {
                if (addCustomSubcategory(categoryId, name.trim())) {
                    renderManagementContent();
                    // Expand the list to show the new item
                    const list = document.getElementById('subList_' + categoryId);
                    if (list) list.classList.add('expanded');
                } else {
                    alert('Subcategory already exists or is invalid.');
                }
            }
        }

        function mgmtEditSubcategory(categoryId, subName, isCustom) {
            const newName = prompt('Edit subcategory name:', subName);
            if (newName && newName.trim() && newName.trim() !== subName) {
                const trimmed = newName.trim();
                
                // Check if new name already exists
                const allSubs = getAllSubcategories(categoryId);
                if (allSubs.includes(trimmed)) {
                    alert('A subcategory with this name already exists.');
                    return;
                }
                
                if (isCustom) {
                    // Update custom subcategory
                    if (customSubcategories[categoryId]) {
                        const idx = customSubcategories[categoryId].indexOf(subName);
                        if (idx !== -1) {
                            customSubcategories[categoryId][idx] = trimmed;
                            saveCustomSubcategories();
                        }
                    }
                } else {
                    // For predefined subcategory, we replace it by:
                    // 1. Adding a custom one with the new name
                    // 2. Marking the old one as "hidden" by storing in a hidden list
                    if (!customSubcategories[categoryId]) {
                        customSubcategories[categoryId] = [];
                    }
                    customSubcategories[categoryId].push(trimmed);
                    saveCustomSubcategories();
                    
                    // Store the hidden predefined subcategory
                    let hiddenSubs = JSON.parse(localStorage.getItem('hiddenSubcategories') || '{}');
                    if (!hiddenSubs[categoryId]) {
                        hiddenSubs[categoryId] = [];
                    }
                    if (!hiddenSubs[categoryId].includes(subName)) {
                        hiddenSubs[categoryId].push(subName);
                    }
                    localStorage.setItem('hiddenSubcategories', JSON.stringify(hiddenSubs));
                }
                
                // Update existing logs
                timeLogs.forEach(log => {
                    if (log.category === categoryId && log.subcategory === subName) {
                        log.subcategory = trimmed;
                    }
                });
                saveLogs();
                
                // Update selected subcategory if it was the one being edited
                if (selectedSubcategory === subName) {
                    selectedSubcategory = trimmed;
                }
            }
            renderManagementContent();
            renderCategories();
        }

        function mgmtDeleteSubcategory(categoryId, subName, isCustom) {
            if (!confirm(`Delete subcategory "${subName}"?`)) {
                return;
            }
            
            if (isCustom) {
                // Delete custom subcategory
                if (customSubcategories[categoryId]) {
                    customSubcategories[categoryId] = customSubcategories[categoryId].filter(s => s !== subName);
                    saveCustomSubcategories();
                }
            } else {
                // Hide predefined subcategory
                let hiddenSubs = JSON.parse(localStorage.getItem('hiddenSubcategories') || '{}');
                if (!hiddenSubs[categoryId]) {
                    hiddenSubs[categoryId] = [];
                }
                if (!hiddenSubs[categoryId].includes(subName)) {
                    hiddenSubs[categoryId].push(subName);
                }
                localStorage.setItem('hiddenSubcategories', JSON.stringify(hiddenSubs));
            }
            
            // Reset selected subcategory if it was the one being deleted
            if (selectedSubcategory === subName) {
                selectedSubcategory = null;
            }
            
            renderManagementContent();
            renderCategories();
        }
        
        function updateEditSubcategoryOptions(logId) {
            const catSelect = document.getElementById(`editCat_${logId}`);
            const subSelect = document.getElementById(`editSub_${logId}`);
            if (!catSelect || !subSelect) return;
            
            const categoryId = catSelect.value;
            const subs = getAllSubcategories(categoryId);
            
            subSelect.innerHTML = '<option value="">-- No subcategory --</option>' + 
                subs.map(s => `<option value="${s}">${s}</option>`).join('') +
                '<option value="__add_new__">➕ Add new...</option>';
        }

        function handleEditSubcategoryChange(logId, originalCategoryId) {
            const catSelect = document.getElementById(`editCat_${logId}`);
            const subSelect = document.getElementById(`editSub_${logId}`);
            if (!catSelect || !subSelect) return;
            
            if (subSelect.value === '__add_new__') {
                const newSub = prompt('Enter new subcategory name:');
                if (newSub && newSub.trim()) {
                    const categoryId = catSelect.value;
                    if (addCustomSubcategory(categoryId, newSub.trim())) {
                        updateEditSubcategoryOptions(logId);
                        subSelect.value = newSub.trim();
                    } else {
                        alert('Subcategory already exists or is invalid.');
                        subSelect.value = '';
                    }
                } else {
                    subSelect.value = '';
                }
            }
        }
        
        function saveLogFromModal(logId, categoryId) {
            const log = timeLogs.find(l => l.id === logId);
            if (!log) return;
            
            const newCatId = document.getElementById(`editCat_${logId}`).value;
            let newSubcategory = document.getElementById(`editSub_${logId}`)?.value || null;
            if (newSubcategory === '__add_new__') newSubcategory = null;
            const startH = parseInt(document.getElementById(`editStartH_${logId}`).value);
            const startM = parseInt(document.getElementById(`editStartM_${logId}`).value);
            const endH = parseInt(document.getElementById(`editEndH_${logId}`).value);
            const endM = parseInt(document.getElementById(`editEndM_${logId}`).value);
            
            // Get the original date (day) from the log
            const originalDate = new Date(log.startTime);
            const year = originalDate.getFullYear();
            const month = originalDate.getMonth();
            const day = originalDate.getDate();
            
            // Build new start/end times
            let newStart = new Date(year, month, day, startH, startM, 0, 0);
            let newEnd = new Date(year, month, day, endH, endM, 0, 0);
            
            // If end is before start, assume it crosses midnight
            if (newEnd <= newStart) {
                newEnd.setDate(newEnd.getDate() + 1);
            }
            
            const newCategory = getAllCategories().find(c => c.id === newCatId);
            if (newCategory) {
                log.category = newCatId;
                log.categoryName = newCategory.name;
                log.categoryColor = newCategory.color;
                log.categoryIcon = newCategory.icon;
            }
            
            log.subcategory = newSubcategory || null;
            log.startTime = newStart.getTime();
            log.endTime = newEnd.getTime();
            log.duration = Math.floor((log.endTime - log.startTime) / 1000);
            
            saveLogs();
            
            // Show success feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✓ Saved!';
            btn.style.background = '#059669';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                // Refresh modal to show updated data
                openCategoryModal(categoryId);
            }, 1000);
        }
        
        function deleteLogFromModal(logId, categoryId) {
            if (!confirm('Delete this log entry?')) return;
            
            timeLogs = timeLogs.filter(log => log.id !== logId);
            saveLogs();
            
            // Check if there are still logs for this category
            const remainingLogs = timeLogs.filter(log => log.category === categoryId);
            if (remainingLogs.length === 0) {
                closeCategoryModal();
            } else {
                openCategoryModal(categoryId); // Refresh modal
            }
        }

        // ============ FIREBASE & AUTH ============
        
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let currentUser = null;
        let unsubscribeSync = null;

        function initFirebase() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (!savedConfig) return false;

            try {
                const config = JSON.parse(savedConfig);
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(config);
                } else {
                    firebaseApp = firebase.apps[0];
                }
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();

                // Listen for auth state changes
                firebaseAuth.onAuthStateChanged(user => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        setupRealtimeSync();
                    } else {
                        if (unsubscribeSync) {
                            unsubscribeSync();
                            unsubscribeSync = null;
                        }
                    }
                });

                return true;
            } catch (err) {
                console.error('Firebase init error:', err);
                return false;
            }
        }

        function updateAuthUI() {
            const btn = document.getElementById('authBtn');
            const status = document.getElementById('syncStatus');
            
            if (currentUser) {
                btn.innerHTML = '👤 ' + (currentUser.email?.split('@')[0] || 'Account');
                btn.classList.add('logged-in');
                status.innerHTML = '☁️ Auto-sync enabled';
            } else {
                btn.innerHTML = '👤 Login';
                btn.classList.remove('logged-in');
                status.innerHTML = '';
            }
        }

        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
            if (currentUser) {
                document.getElementById('authLoginView').style.display = 'none';
                document.getElementById('authAccountView').style.display = 'block';
                document.getElementById('accountEmail').textContent = currentUser.email;
                document.getElementById('authTitle').textContent = '👤 My Account';
                
                const lastSync = localStorage.getItem('lastCloudSync');
                if (lastSync) {
                    document.getElementById('lastSyncTime').textContent = 
                        'Last synced: ' + new Date(lastSync).toLocaleString();
                }
            } else {
                document.getElementById('authLoginView').style.display = 'block';
                document.getElementById('authAccountView').style.display = 'none';
                document.getElementById('authTitle').textContent = '👤 Login / Sign Up';
            }
        }

        function closeAuthModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('authModal').classList.remove('active');
        }

        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const submitBtn = document.getElementById('authSubmitBtn');
            submitBtn.textContent = tab === 'login' ? 'Login' : 'Sign Up';
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();
            
            if (!firebaseAuth) {
                alert('Please configure Firebase first. Click the setup info below.');
                return;
            }

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const isLogin = document.getElementById('authSubmitBtn').textContent === 'Login';

            try {
                if (isLogin) {
                    await firebaseAuth.signInWithEmailAndPassword(email, password);
                } else {
                    await firebaseAuth.createUserWithEmailAndPassword(email, password);
                }
                closeAuthModal();
                syncToCloud();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function signInWithGoogle() {
            if (!firebaseAuth) {
                alert('Please configure Firebase first. Click the setup info below.');
                return;
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
                closeAuthModal();
                syncToCloud();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function logoutUser() {
            if (firebaseAuth) {
                await firebaseAuth.signOut();
            }
            closeAuthModal();
        }

        function showFirebaseConfig() {
            closeAuthModal();
            document.getElementById('firebaseConfigModal').classList.add('active');
            
            const saved = localStorage.getItem('firebaseConfig');
            if (saved) {
                document.getElementById('firebaseConfigInput').value = saved;
            }
        }

        function closeFirebaseConfig(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('firebaseConfigModal').classList.remove('active');
        }

        function saveFirebaseConfig() {
            const input = document.getElementById('firebaseConfigInput').value.trim();
            
            try {
                const config = JSON.parse(input);
                if (!config.apiKey || !config.projectId) {
                    throw new Error('Missing required fields');
                }
                
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                if (initFirebase()) {
                    alert('✅ Firebase configured successfully!\n\nYou can now login to enable automatic sync.');
                    closeFirebaseConfig();
                    openAuthModal();
                } else {
                    alert('❌ Failed to initialize Firebase. Please check your config.');
                }
            } catch (err) {
                alert('❌ Invalid configuration. Please paste a valid JSON object.\n\n' + err.message);
            }
        }

        async function syncToCloud() {
            if (!currentUser || !firebaseDb) {
                alert('Please login first to sync to cloud.');
                return;
            }

            const status = document.getElementById('syncStatus');
            status.innerHTML = '🔄 Syncing...';

            try {
                const data = getAllData();
                await firebaseDb.collection('users').doc(currentUser.uid).set({
                    data: data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                localStorage.setItem('lastCloudSync', new Date().toISOString());
                status.innerHTML = '✅ Synced!';
                
                setTimeout(() => {
                    status.innerHTML = '☁️ Auto-sync enabled';
                }, 2000);

                // Update last sync time in modal if open
                const lastSyncEl = document.getElementById('lastSyncTime');
                if (lastSyncEl) {
                    lastSyncEl.textContent = 'Last synced: ' + new Date().toLocaleString();
                }
            } catch (err) {
                console.error('Sync error:', err);
                status.innerHTML = '❌ Sync failed';
            }
        }

        async function loadFromCloud() {
            if (!currentUser || !firebaseDb) return;

            try {
                const doc = await firebaseDb.collection('users').doc(currentUser.uid).get();
                if (doc.exists && doc.data().data) {
                    const cloudData = doc.data().data;
                    
                    // Check if cloud data is newer
                    const localSync = localStorage.getItem('lastCloudSync');
                    const cloudTime = doc.data().updatedAt?.toDate();
                    
                    if (!localSync || (cloudTime && new Date(cloudTime) > new Date(localSync))) {
                        // Cloud is newer, merge data
                        processImportedData(cloudData);
                    }
                }
            } catch (err) {
                console.error('Load from cloud error:', err);
            }
        }

        function setupRealtimeSync() {
            if (!currentUser || !firebaseDb) return;

            // First load from cloud
            loadFromCloud();

            // Then listen for changes
            unsubscribeSync = firebaseDb.collection('users').doc(currentUser.uid)
                .onSnapshot(doc => {
                    if (doc.exists && doc.data().data) {
                        const cloudData = doc.data().data;
                        const localSync = localStorage.getItem('lastCloudSync');
                        const cloudTime = doc.data().updatedAt?.toDate();
                        
                        // Only update if cloud is newer and not our own update
                        if (cloudTime && localSync && new Date(cloudTime) > new Date(localSync)) {
                            console.log('Cloud data updated, syncing...');
                            processImportedData(cloudData);
                            localStorage.setItem('lastCloudSync', cloudTime.toISOString());
                        }
                    }
                });
        }

        // Auto-sync when data changes
        function autoSyncToCloud() {
            if (currentUser && firebaseDb) {
                // Debounce sync
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(() => {
                    syncToCloud();
                }, 2000);
            }
        }

        // Override save functions to trigger auto-sync
        const originalSaveLogs = saveLogs;
        saveLogs = function() {
            originalSaveLogs();
            autoSyncToCloud();
        };

        const originalSaveCustomCategories = saveCustomCategories;
        saveCustomCategories = function() {
            originalSaveCustomCategories();
            autoSyncToCloud();
        };

        const originalSaveCustomSubcategories = saveCustomSubcategories;
        saveCustomSubcategories = function() {
            originalSaveCustomSubcategories();
            autoSyncToCloud();
        };

        // ============ SYNC FUNCTIONS ============
        
        function openSyncModal() {
            document.getElementById('syncModal').classList.add('active');
        }

        function closeSyncModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('syncModal').classList.remove('active');
        }

        function getAllData() {
            return {
                version: '1.0',
                exportDate: new Date().toISOString(),
                timeLogs: timeLogs,
                customCategories: customCategories,
                customSubcategories: customSubcategories,
                modifiedDefaults: modifiedDefaults,
                deletedDefaults: deletedDefaults,
                hiddenSubcategories: JSON.parse(localStorage.getItem('hiddenSubcategories') || '{}')
            };
        }

        function exportData() {
            const data = getAllData();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `time-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ Data exported successfully!\n\nTransfer this file to your other device and use "Upload Data File" to import.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processImportedData(data);
                } catch (err) {
                    alert('❌ Error reading file. Please make sure it\'s a valid Hourglass backup file.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function processImportedData(data) {
            if (!data.timeLogs && !data.customCategories) {
                alert('❌ Invalid data format. This doesn\'t appear to be a Hourglass backup.');
                return;
            }

            const mergeChoice = confirm(
                '📥 Data found!\n\n' +
                `• ${(data.timeLogs || []).length} time logs\n` +
                `• ${(data.customCategories || []).length} custom categories\n\n` +
                'Choose merge option:\n' +
                '• OK = Merge with existing data (keep both)\n' +
                '• Cancel = Replace all data (overwrite)'
            );

            if (mergeChoice) {
                // Merge data
                if (data.timeLogs) {
                    const existingIds = new Set(timeLogs.map(l => l.id));
                    data.timeLogs.forEach(log => {
                        if (!existingIds.has(log.id)) {
                            timeLogs.push(log);
                        }
                    });
                }
                if (data.customCategories) {
                    const existingIds = new Set(customCategories.map(c => c.id));
                    data.customCategories.forEach(cat => {
                        if (!existingIds.has(cat.id)) {
                            customCategories.push(cat);
                        }
                    });
                }
                if (data.customSubcategories) {
                    Object.keys(data.customSubcategories).forEach(catId => {
                        if (!customSubcategories[catId]) {
                            customSubcategories[catId] = [];
                        }
                        data.customSubcategories[catId].forEach(sub => {
                            if (!customSubcategories[catId].includes(sub)) {
                                customSubcategories[catId].push(sub);
                            }
                        });
                    });
                }
            } else {
                // Replace all
                timeLogs = data.timeLogs || [];
                customCategories = data.customCategories || [];
                customSubcategories = data.customSubcategories || {};
                modifiedDefaults = data.modifiedDefaults || {};
                deletedDefaults = data.deletedDefaults || [];
                if (data.hiddenSubcategories) {
                    localStorage.setItem('hiddenSubcategories', JSON.stringify(data.hiddenSubcategories));
                }
            }

            // Save all
            saveLogs();
            saveCustomCategories();
            saveCustomSubcategories();
            saveModifiedDefaults();
            saveDeletedDefaults();

            // Refresh UI
            renderCategories();
            updateLogsView();
            updateManualCategoryDropdown();

            alert('✅ Data imported successfully!\n\nYour time logs and settings have been synced.');
            closeSyncModal();
        }

        function copySyncCode() {
            const data = getAllData();
            const compressed = btoa(encodeURIComponent(JSON.stringify(data)));
            
            navigator.clipboard.writeText(compressed).then(() => {
                document.getElementById('syncCodeDisplay').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('syncCodeDisplay').style.display = 'none';
                }, 3000);
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = compressed;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                document.getElementById('syncCodeDisplay').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('syncCodeDisplay').style.display = 'none';
                }, 3000);
            });
        }

        function importSyncCode() {
            const input = document.getElementById('syncCodeInput');
            const code = input.value.trim();
            
            if (!code) {
                alert('Please paste a sync code first.');
                return;
            }

            try {
                const json = decodeURIComponent(atob(code));
                const data = JSON.parse(json);
                processImportedData(data);
                input.value = '';
            } catch (err) {
                alert('❌ Invalid sync code. Please make sure you copied the entire code.');
            }
        }

        // Initialize on load
        init();
        
        // Initialize Firebase if configured
        initFirebase();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button if needed
            showInstallButton();
        });

        function showInstallButton() {
            // Add install button to header if not already there
            if (!document.getElementById('installBtn')) {
                const header = document.querySelector('.app-header');
                if (header) {
                    const btn = document.createElement('button');
                    btn.id = 'installBtn';
                    btn.className = 'install-btn';
                    btn.innerHTML = '📲 Install App';
                    btn.onclick = installApp;
                    header.appendChild(btn);
                }
            }
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                    }
                    deferredPrompt = null;
                    const btn = document.getElementById('installBtn');
                    if (btn) btn.remove();
                });
            }
        }

        window.addEventListener('appinstalled', () => {
            console.log('App installed');
            const btn = document.getElementById('installBtn');
            if (btn) btn.remove();
        });
    </script>
</body>
</html>
